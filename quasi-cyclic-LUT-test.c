#include <stdio.h>
#include <stdint.h>

const uint8_t LUT[256] = {
    0x00, // Syndrome 0x00
    0x00, // Syndrome 0x01
    0x00, // Syndrome 0x02
    0x00, // Syndrome 0x03
    0x00, // Syndrome 0x04
    0x00, // Syndrome 0x05
    0x00, // Syndrome 0x06
    0x00, // Syndrome 0x07
    0x00, // Syndrome 0x08
    0x00, // Syndrome 0x09
    0x00, // Syndrome 0x0A
    0x10, // Syndrome 0x0B
    0x00, // Syndrome 0x0C
    0x00, // Syndrome 0x0D
    0x00, // Syndrome 0x0E
    0xA0, // Syndrome 0x0F
    0x00, // Syndrome 0x10
    0x00, // Syndrome 0x11
    0x00, // Syndrome 0x12
    0x00, // Syndrome 0x13
    0x00, // Syndrome 0x14
    0x08, // Syndrome 0x15
    0x20, // Syndrome 0x16
    0x00, // Syndrome 0x17
    0x00, // Syndrome 0x18
    0x80, // Syndrome 0x19
    0x00, // Syndrome 0x1A
    0x00, // Syndrome 0x1B
    0x00, // Syndrome 0x1C
    0x00, // Syndrome 0x1D
    0x41, // Syndrome 0x1E
    0x00, // Syndrome 0x1F
    0x00, // Syndrome 0x20
    0x00, // Syndrome 0x21
    0x00, // Syndrome 0x22
    0x10, // Syndrome 0x23
    0x00, // Syndrome 0x24
    0x02, // Syndrome 0x25
    0x00, // Syndrome 0x26
    0x09, // Syndrome 0x27
    0x00, // Syndrome 0x28
    0x10, // Syndrome 0x29
    0x10, // Syndrome 0x2A
    0x10, // Syndrome 0x2B
    0x40, // Syndrome 0x2C
    0x00, // Syndrome 0x2D
    0x00, // Syndrome 0x2E
    0x10, // Syndrome 0x2F
    0x00, // Syndrome 0x30
    0x00, // Syndrome 0x31
    0x01, // Syndrome 0x32
    0x22, // Syndrome 0x33
    0x00, // Syndrome 0x34
    0x00, // Syndrome 0x35
    0x00, // Syndrome 0x36
    0x00, // Syndrome 0x37
    0x00, // Syndrome 0x38
    0x48, // Syndrome 0x39
    0x00, // Syndrome 0x3A
    0x10, // Syndrome 0x3B
    0x82, // Syndrome 0x3C
    0x00, // Syndrome 0x3D
    0x00, // Syndrome 0x3E
    0x00, // Syndrome 0x3F
    0x00, // Syndrome 0x40
    0x00, // Syndrome 0x41
    0x00, // Syndrome 0x42
    0x00, // Syndrome 0x43
    0x00, // Syndrome 0x44
    0x02, // Syndrome 0x45
    0x20, // Syndrome 0x46
    0x00, // Syndrome 0x47
    0x00, // Syndrome 0x48
    0x80, // Syndrome 0x49
    0x04, // Syndrome 0x4A
    0x00, // Syndrome 0x4B
    0x00, // Syndrome 0x4C
    0x00, // Syndrome 0x4D
    0x12, // Syndrome 0x4E
    0x00, // Syndrome 0x4F
    0x00, // Syndrome 0x50
    0x80, // Syndrome 0x51
    0x20, // Syndrome 0x52
    0x00, // Syndrome 0x53
    0x20, // Syndrome 0x54
    0x00, // Syndrome 0x55
    0x20, // Syndrome 0x56
    0x20, // Syndrome 0x57
    0x80, // Syndrome 0x58
    0x80, // Syndrome 0x59
    0x00, // Syndrome 0x5A
    0x80, // Syndrome 0x5B
    0x00, // Syndrome 0x5C
    0x80, // Syndrome 0x5D
    0x20, // Syndrome 0x5E
    0x0C, // Syndrome 0x5F
    0x00, // Syndrome 0x60
    0x02, // Syndrome 0x61
    0x00, // Syndrome 0x62
    0x00, // Syndrome 0x63
    0x02, // Syndrome 0x64
    0x02, // Syndrome 0x65
    0x44, // Syndrome 0x66
    0x02, // Syndrome 0x67
    0x00, // Syndrome 0x68
    0x00, // Syndrome 0x69
    0x00, // Syndrome 0x6A
    0x10, // Syndrome 0x6B
    0x00, // Syndrome 0x6C
    0x02, // Syndrome 0x6D
    0x00, // Syndrome 0x6E
    0x00, // Syndrome 0x6F
    0x00, // Syndrome 0x70
    0x00, // Syndrome 0x71
    0x90, // Syndrome 0x72
    0x00, // Syndrome 0x73
    0x00, // Syndrome 0x74
    0x02, // Syndrome 0x75
    0x20, // Syndrome 0x76
    0x00, // Syndrome 0x77
    0x05, // Syndrome 0x78
    0x80, // Syndrome 0x79
    0x00, // Syndrome 0x7A
    0x00, // Syndrome 0x7B
    0x00, // Syndrome 0x7C
    0x30, // Syndrome 0x7D
    0x00, // Syndrome 0x7E
    0x00, // Syndrome 0x7F
    0x00, // Syndrome 0x80
    0x00, // Syndrome 0x81
    0x00, // Syndrome 0x82
    0x00, // Syndrome 0x83
    0x00, // Syndrome 0x84
    0x08, // Syndrome 0x85
    0x00, // Syndrome 0x86
    0x50, // Syndrome 0x87
    0x00, // Syndrome 0x88
    0x00, // Syndrome 0x89
    0x04, // Syndrome 0x8A
    0x00, // Syndrome 0x8B
    0x40, // Syndrome 0x8C
    0x00, // Syndrome 0x8D
    0x00, // Syndrome 0x8E
    0x00, // Syndrome 0x8F
    0x00, // Syndrome 0x90
    0x08, // Syndrome 0x91
    0x01, // Syndrome 0x92
    0x84, // Syndrome 0x93
    0x08, // Syndrome 0x94
    0x08, // Syndrome 0x95
    0x00, // Syndrome 0x96
    0x08, // Syndrome 0x97
    0x00, // Syndrome 0x98
    0x11, // Syndrome 0x99
    0x00, // Syndrome 0x9A
    0x00, // Syndrome 0x9B
    0x24, // Syndrome 0x9C
    0x08, // Syndrome 0x9D
    0x00, // Syndrome 0x9E
    0x00, // Syndrome 0x9F
    0x00, // Syndrome 0xA0
    0x00, // Syndrome 0xA1
    0x01, // Syndrome 0xA2
    0x00, // Syndrome 0xA3
    0x40, // Syndrome 0xA4
    0x00, // Syndrome 0xA5
    0x00, // Syndrome 0xA6
    0x00, // Syndrome 0xA7
    0x40, // Syndrome 0xA8
    0x00, // Syndrome 0xA9
    0x00, // Syndrome 0xAA
    0x10, // Syndrome 0xAB
    0x40, // Syndrome 0xAC
    0x40, // Syndrome 0xAD
    0x40, // Syndrome 0xAE
    0x06, // Syndrome 0xAF
    0x01, // Syndrome 0xB0
    0x00, // Syndrome 0xB1
    0x01, // Syndrome 0xB2
    0x01, // Syndrome 0xB3
    0x00, // Syndrome 0xB4
    0x08, // Syndrome 0xB5
    0x01, // Syndrome 0xB6
    0x00, // Syndrome 0xB7
    0x00, // Syndrome 0xB8
    0x00, // Syndrome 0xB9
    0x01, // Syndrome 0xBA
    0x00, // Syndrome 0xBB
    0x40, // Syndrome 0xBC
    0x00, // Syndrome 0xBD
    0x18, // Syndrome 0xBE
    0x00, // Syndrome 0xBF
    0x00, // Syndrome 0xC0
    0x00, // Syndrome 0xC1
    0x04, // Syndrome 0xC2
    0x28, // Syndrome 0xC3
    0x00, // Syndrome 0xC4
    0x00, // Syndrome 0xC5
    0x00, // Syndrome 0xC6
    0x00, // Syndrome 0xC7
    0x04, // Syndrome 0xC8
    0x42, // Syndrome 0xC9
    0x04, // Syndrome 0xCA
    0x04, // Syndrome 0xCB
    0x88, // Syndrome 0xCC
    0x00, // Syndrome 0xCD
    0x04, // Syndrome 0xCE
    0x00, // Syndrome 0xCF
    0x00, // Syndrome 0xD0
    0x00, // Syndrome 0xD1
    0x00, // Syndrome 0xD2
    0x00, // Syndrome 0xD3
    0x00, // Syndrome 0xD4
    0x08, // Syndrome 0xD5
    0x20, // Syndrome 0xD6
    0x03, // Syndrome 0xD7
    0x00, // Syndrome 0xD8
    0x80, // Syndrome 0xD9
    0x04, // Syndrome 0xDA
    0x00, // Syndrome 0xDB
    0x00, // Syndrome 0xDC
    0x00, // Syndrome 0xDD
    0x00, // Syndrome 0xDE
    0x00, // Syndrome 0xDF
    0x00, // Syndrome 0xE0
    0x14, // Syndrome 0xE1
    0x00, // Syndrome 0xE2
    0x00, // Syndrome 0xE3
    0x21, // Syndrome 0xE4
    0x02, // Syndrome 0xE5
    0x00, // Syndrome 0xE6
    0x00, // Syndrome 0xE7
    0x00, // Syndrome 0xE8
    0x00, // Syndrome 0xE9
    0x04, // Syndrome 0xEA
    0x81, // Syndrome 0xEB
    0x40, // Syndrome 0xEC
    0x00, // Syndrome 0xED
    0x00, // Syndrome 0xEE
    0x00, // Syndrome 0xEF
    0x0A, // Syndrome 0xF0
    0x00, // Syndrome 0xF1
    0x01, // Syndrome 0xF2
    0x00, // Syndrome 0xF3
    0x00, // Syndrome 0xF4
    0xC0, // Syndrome 0xF5
    0x00, // Syndrome 0xF6
    0x00, // Syndrome 0xF7
    0x00, // Syndrome 0xF8
    0x00, // Syndrome 0xF9
    0x60, // Syndrome 0xFA
    0x00, // Syndrome 0xFB
    0x00, // Syndrome 0xFC
    0x00, // Syndrome 0xFD
    0x00, // Syndrome 0xFE
    0x00, // Syndrome 0xFF
};

const uint8_t P[256] = {
0x00, 0xB2, 0x65, 0xD7, 0xCA, 0x78, 0xAF, 0x1D, 0x95, 0x27, 0xF0, 0x42, 0x5F, 0xED, 0x3A, 0x88,
0x2B, 0x99, 0x4E, 0xFC, 0xE1, 0x53, 0x84, 0x36, 0xBE, 0x0C, 0xDB, 0x69, 0x74, 0xC6, 0x11, 0xA3,
0x56, 0xE4, 0x33, 0x81, 0x9C, 0x2E, 0xF9, 0x4B, 0xC3, 0x71, 0xA6, 0x14, 0x09, 0xBB, 0x6C, 0xDE,
0x7D, 0xCF, 0x18, 0xAA, 0xB7, 0x05, 0xD2, 0x60, 0xE8, 0x5A, 0x8D, 0x3F, 0x22, 0x90, 0x47, 0xF5,
0xAC, 0x1E, 0xC9, 0x7B, 0x66, 0xD4, 0x03, 0xB1, 0x39, 0x8B, 0x5C, 0xEE, 0xF3, 0x41, 0x96, 0x24,
0x87, 0x35, 0xE2, 0x50, 0x4D, 0xFF, 0x28, 0x9A, 0x12, 0xA0, 0x77, 0xC5, 0xD8, 0x6A, 0xBD, 0x0F,
0xFA, 0x48, 0x9F, 0x2D, 0x30, 0x82, 0x55, 0xE7, 0x6F, 0xDD, 0x0A, 0xB8, 0xA5, 0x17, 0xC0, 0x72,
0xD1, 0x63, 0xB4, 0x06, 0x1B, 0xA9, 0x7E, 0xCC, 0x44, 0xF6, 0x21, 0x93, 0x8E, 0x3C, 0xEB, 0x59,
0x59, 0xEB, 0x3C, 0x8E, 0x93, 0x21, 0xF6, 0x44, 0xCC, 0x7E, 0xA9, 0x1B, 0x06, 0xB4, 0x63, 0xD1,
0x72, 0xC0, 0x17, 0xA5, 0xB8, 0x0A, 0xDD, 0x6F, 0xE7, 0x55, 0x82, 0x30, 0x2D, 0x9F, 0x48, 0xFA,
0x0F, 0xBD, 0x6A, 0xD8, 0xC5, 0x77, 0xA0, 0x12, 0x9A, 0x28, 0xFF, 0x4D, 0x50, 0xE2, 0x35, 0x87,
0x24, 0x96, 0x41, 0xF3, 0xEE, 0x5C, 0x8B, 0x39, 0xB1, 0x03, 0xD4, 0x66, 0x7B, 0xC9, 0x1E, 0xAC,
0xF5, 0x47, 0x90, 0x22, 0x3F, 0x8D, 0x5A, 0xE8, 0x60, 0xD2, 0x05, 0xB7, 0xAA, 0x18, 0xCF, 0x7D,
0xDE, 0x6C, 0xBB, 0x09, 0x14, 0xA6, 0x71, 0xC3, 0x4B, 0xF9, 0x2E, 0x9C, 0x81, 0x33, 0xE4, 0x56,
0xA3, 0x11, 0xC6, 0x74, 0x69, 0xDB, 0x0C, 0xBE, 0x36, 0x84, 0x53, 0xE1, 0xFC, 0x4E, 0x99, 0x2B,
0x88, 0x3A, 0xED, 0x5F, 0x42, 0xF0, 0x27, 0x95, 0x1D, 0xAF, 0x78, 0xCA, 0xD7, 0x65, 0xB2, 0x00,
};

// data_byte: 8 bits (as uint8_t)
// parity_matrix: 8 rows, each 8 bits (uint8_t[8])
// Returns: 16-bit codeword (8 parity bits | 8 data bits)
uint16_t encode(uint8_t data_byte) {
    const uint16_t codeword = (P[data_byte] << 8) | data_byte;
    return codeword;
}

// codeword: 16 bits (uint16_t)
// Returns: corrected data byte (uint8_t)
uint8_t decode(uint16_t codeword) {
    // Compute syndrome (8 bits)
    const uint8_t syndrome = P[codeword & 0xFF] ^ (codeword >> 8);

    // Look up error pattern in LUT
    const uint16_t error_pattern = LUT[syndrome];
//    printf("Syndrome: 0x%02X, Error Pattern: 0x%04X\n", syndrome, error_pattern);

    // Correct the codeword
    const uint16_t corrected = codeword ^ error_pattern;

    // Return the lower 8 bits (data byte)
    return (uint8_t)(corrected & 0xFF);
}

int success_count = 0;
int failure_count = 0;

void test(uint8_t data_byte, uint16_t flipped_bits) {
    const uint16_t encoded = encode(data_byte);
    const uint8_t decoded = decode(encoded ^ flipped_bits); // Introduce bit errors for testing

    if (decoded != data_byte) {
        printf("Failed: Data byte: 0x%02X, Encoded: 0x%04X, Decoded: 0x%02X\n", data_byte, encoded, decoded);
        failure_count++;
    }
    else {
//            printf("Success: Data byte: 0x%02X, Encoded: 0x%04X, Decoded: 0x%02X\n", data_byte, encoded, decoded);
        success_count++; 
    }
}
int main() {
    // Example usage
    printf("Testing Quasi-Cyclic LUT.\n");
    for (uint16_t data_byte = 0; data_byte < 256; data_byte++) {
        test((uint8_t)data_byte, 0);

        for (int i = 0; i < 16; i++) {
            // Test with each single bit flipped
            test((uint8_t)data_byte, (1 << i));
        }

        for (int i = 0; i < 15; i++) {
            for (int j = i+1; j < 16; j++) {
            // Test with each pair of bits flipped
                test((uint8_t)data_byte, (1 << i) | (1 << j) );
            }
        }

    }

    printf("Total successes: %d, Total failures: %d\n", success_count, failure_count);
    if (failure_count > 0)
        return 1;

    return 0;
}